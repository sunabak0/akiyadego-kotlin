---
sidebar_position: 3
title: なぜ不整合な状況・状態を作成不可能にするのか
slug: /why_should_structures_that_can_create_inconsistent_data_be_avoided
---

# なぜ不整合な状況・状態を作成不可能にするのか

## 答え

| idx | 理由                                                            |
|:---:|:--------------------------------------------------------------|
|  1  | 不整合な状況・状態への考慮不足が起きうる状況が減ると考えているから                             |
|  2  | 不整合な状況・状態は作成不可能なので、その状態・状況のテストはできないから(「記述できるが、記述しない」という場合が多い) |

## ありがちだけど避けたい流れ

```mermaid
flowchart TB
1["1. 別機能追加や剪定により、考慮漏れから不整合なデータが作られる"]
1 --> 2["2. エラーが起きる"]
2 --> 3["3. アラートが飛ぶ"]
3 --> 4["4. エラー調査"]
4 --> 5["5. 考慮漏れ発見"]
5 --> 6["6. `考慮漏れの部分` を修正"]
6 --> 7["7. できるだけ状況・状態の組み合わせを考慮した `自動テストを書こう`"]
7 --> 8["8. 全ての文脈の組み合わせは無理筋なので、 `パターンを限って記述しよう`"]
8 --> 1
```

## 伝えたいこと

:::danger ありがちだけど避けたいこと
- 修正されるのは考慮漏れの部分 `のみ`
- 修正によって、不整合な状況・状態を `作らない` ようにしている
  - 確認するのは `人間の目` や `自動テスト`
:::

:::tip 目指したいこと
- 不整合な状況・状態(データ)が `考慮不足が起きうる状況` を減らそう
- 不整合な状況・状態(データ)を `作れない` ようにしよう
  - そもそも確認を不要にしよう
:::

:::caution こういうことではない
- `全ての組み合わせテストを書こう`ではない
- `考慮不足を減らそう` ではない
:::

#### 蛇足

- 目指したいことを実現するには、どういうパターンがあって、どういうパターンは `ない` のか、しっかりとした分析をする必要がある
- 不整合な状況・状態を `作れない` → アプリのバグを 0 にできるというわけではない
  - 不整合な状況・状態同士の組み合わせで不整合はありえたりする
    - これをまた1つのデータ構造でラップしてありえないようにすることは可能かもしれないが、 0 にするレベルまでだと多分辛い
- 人間が考慮しなくても、コンパイラが考慮してくれる世界でプログラミングしたい
- レビューでもレビュアーが考慮することも減らせる
- OKのコードでも、まだ不整合なデータは作ることができる
  - 空のListを持つバリデーションエラー
    - `NotEmptyList<String>` 的なデータ構造が標準で欲しくなる