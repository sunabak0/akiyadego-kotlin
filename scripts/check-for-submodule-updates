#!/bin/bash

################################################################################
# Check for submodule updates
################################################################################
#
# æ¦‚è¦
# - submodule ã«æ›´æ–°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
#
# exit code: 0 : æ›´æ–°ã¯ãªã„ ( æœ€æ–°çŠ¶æ…‹ã§ã‚ã‚‹ )
# exit code: 1 : æ›´æ–°ãŒã‚ã‚‹
#

GIT_SUBMODULE="akiyadego-openapi"
readonly GIT_SUBMODULE

#
# submodule ã§ã®ä½œæ¥­å†…å®¹ã‚’é€€é¿
#
function stash_on_git_submodule() {
  cd "${GIT_SUBMODULE}" || exit 1
  git stage .
  git stash -q -m "$(date +%Y-%m-%dT%H:%M:%S) : check-for-submodule-updates ã«ã‚ˆã£ã¦ stash ã—ã¾ã—ãŸ" > /dev/null
  cd - || exit 1
}

#
# æ›´æ–°ãŒã‚ã‚‹ã‹ç¢ºèª
#
function exist_diff_from_the_latest() {
  git submodule update --init --recursive --remote -- "${GIT_SUBMODULE}" > /dev/null
  git status --short ${GIT_SUBMODULE} | wc -l | grep -q 0
}

#
# Main
#
function main() {
  stash_on_git_submodule
  if exist_diff_from_the_latest; then
    echo ""
    echo "ðŸ‘ Nothing submodule updates: ${GIT_SUBMODULE} submodule is latest."
    echo ""
    # ç¾åœ¨ã® branch ã® submodule ã®çŠ¶æ…‹ã«æˆ»ã™
    git submodule update -- "${GIT_SUBMODULE}" > /dev/null
    exit 0
  else
    echo ""
    echo "ðŸ§ Found submodule updates: ${GIT_SUBMODULE} submodule is up to date." >&2
    echo ""
    # ç¾åœ¨ã® branch ã® submodule ã®çŠ¶æ…‹ã«æˆ»ã™
    git submodule update -- "${GIT_SUBMODULE}" > /dev/null
    exit 1
  fi
}

main
